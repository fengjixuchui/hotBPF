# Overview
Oftentimes there can be a large window between a kernel vulnerability disclosure and its remediation, leaving the system open for exploitation. 
`hotBPF` is designed to protect the Linux kernel from memory exploitation during this time window.

At a high level, `hotBPF` uses eBPF mechanism to isolate memory corruption at run time, 
preventing memory corruption from overwriting/overeading sensitive data (e.g., function pointer). 

Technically, it first statically analyzes bug report generated by Syzkaller (and other compatible bug discovery tools) to 
identify vulnerable structures (i.e., where corruption happens). 
Then it uses the eBPF mechanism and virtual memory allocator in the kernel to isolate vulnerable structures.

The advantages of `hotBPF` are as follow:
- automatically deploy protection immediately after the vulnerability disclosure
- can be enabled on-the-fly, no need to disrupt critical services to recompile and reboot the system (that's why it is called hot)
- compared with existing memory exploitation mitigations in the Linux kernel, 
this protection can offer stronger security protection by preventing cross-cache exploitation
- independent of hardware features and hypervisor virtualization, can be widely deployed in a variety of scenarios 
(e.g., embedded systems, desktops, and cloud servers)
- lightweight - negligible overhead

# Setup Instruction

## Static Analysis
The goal of static analysis is to analyze bug reports and identify vulnerable structures as well as their allocation sites in the kernel image.

In [testcase/](https://github.com/chenyueqi/hotBPF/tree/master/testcase), we provide some reports that can be used as demos. 
There are thousands of bug reports that can be analyzed in [Syzbot](https://syzkaller.appspot.com/upstream)

Taking `bug-kobject_add_internal` as an example, we demonstrate how to use our analyzer. 
`bug-kobject_add_internal` corresponds to the report [BUG: corrupted list in kobject_add_internal](https://syzkaller.appspot.com/bug?id=f0ec9a394925aafbdf13d0a7e6af4cff860f0ed6)

### Step 1: build kernel bitcode 
Follow [here](https://github.com/Markakd/LLVM-O0-BitcodeWriter) to build a clang that can generate O0 bitcode for static analysis. 
Then, build v5.8 kernel (the reported vulnerable version) using config file in the report.
Remember to use our customized clang and build the kernel to the folder `testcase/bug-kobject_add_internal/linux-bitcode`

### Step 2: extract call trace from raw report
```bash
cd src/analyzer
python get_cg.py ../../testcase/bug-kobject_add_internal/report
```

### Step 3: build our analyzer
Our analyzer depends on LLVM-10, so make sure LLVM-10 is installed. Follow [here](https://apt.llvm.org/) to install LLVM-10.
`sudo apt install libstdc++-10-dev` if lstdc++ is not found.

### Step 4: run analyer to identify vulenrable structure
`python run_analyzer.py ../../testcase/bug-kobject_add_internal`

Output: 
`Found:
struct.hci_conn`

### Step 5: obtain allocation sites of vulnerable structures
```bash
./build/lib/analyzer -struct hci_conn `find ../../testcase/bug-kobject_add_internal/linux-bitcode/ -name "*.bc"`
```

Output:
`dumping location of allocating hci_conn 
hci_conn_add net/bluetooth/hci_conn.c:525  
`

## Dynamic Isolation
In this part, `hotBPF` installs eBPF programs to the kernel to intercept the allocation of `struct hci_conn` and divert it to virtual memory allocator.

Continue using `bug-kobject_add_internal` as an example, we demonstrate how to harden ubuntu distro

### Step 1: build and install hardened kernel image
```bash
mkdir -p baremetal/linux-5.8-harden
cd baremetal/linux-5.8-harden
wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-5.8.tar.gz
tar xvf linux-5.8.tar.gz
cd linux-5.8
```

Copy and paste all patch files in [patch/linux-5.8-helper-patch/linux](https://github.com/chenyueqi/hotBPF/tree/master/patch/linux-5.8-helper-patch/linux)

```bash
make -j4 deb-pkg
cd ..
sudo dpkg -i linux-*.deb
```

Reboot the whole system to run hardened kernel

### Step 2: compile and install eBPF program
```
cd src/bpf/bug-kobject_add_internal
make
sudo ./hotbpf
```
